---
title: MPI与并行计算04:对等模式
subtitle: 
layout: post
author: "熊巍"
header-style: text
tags:
  - MPI
  - 并行计算
---

# 一、对等模式

本部分内容将分为两章介绍两种基本的并行程序设计模式，对等模式和主从模式。顾名思义，对等模式即在设计算法时将各进程的地位视为相等，主从模式则把各进程的地位视作不相等，有主进程和从进程之分。

在对等模式中，各个进程的功能基本相同，因此用SPMD（单程序多数据）程序可以更好的表达。在讲解对等模式时，常用Jacobi迭代作为范例。Jacobi迭代在数值计算上是比较常用的算法，本文只考虑其算法本身，不考虑该方法的其他意义。因此后文只介绍其算法的计算规则，具体算法使用背景可自行检索。

由于时间原因，本文的伪代码是使用Fortran写的，之后会补充上C的版本。本文尽量使用最常规的语法规则去写，因此不论更擅长哪门编程语言，应该都能在伪代码中看到其并行算法的思想。如果你更擅长使用C语言，可以尝试参考结尾的Fortran代码用C语言进行改写。

# 二、Jacobi迭代算法介绍

通俗的讲，Jacobi迭代就是用上下左右周围的四个点取平均值来得到新的点，即

$$
A(i,j)=0.25\ast(A(i-1,j)+A(i+1,j)+A(i,j-1)+A(i,j+1))
$$
每一轮迭代计算所用的数值都是上一轮的结果，即还需要额外声明一个变量来储存当前这一轮迭代的结果，然后在迭代完成后刷新矩阵A的值。以下为Jacobi迭代的串行实现的Fortran伪代码。

```fortran
program Jacobi
    integer,parameter :: N=15
    real :: A(N+1,N+1),B(N+1,N+1) !假设计算规模是16x16的矩阵
    integer :: step !step为迭代的次数
    ! 略去赋值部分
    do k=1,step
        do i=2,N
            do j=2,N
                B(i,j)=0.25*(A(i-1,j)+A(i+1,j)+A(i,j+1)+A(i,j-1))
            end do
        end do
        do i=2,N
            do j=2,N
                A(i,j)=B(i,j)
            end do
        end do
    end do
    end program
```

上述的伪代码可以看出，在同一轮迭代中，计算任意一点之间都是相互独立的，代码的局部性很好，在这种情况下，就很适合把代码改成并行来提速。下文将一步步从串行代码改写为并行代码。

# 三、MPI编写Jacobi迭代算法

假设我们的A矩阵是16x16的，可以考虑使用4个进程来完成该Jacobi迭代。因为所迭代的矩阵A是一个二维数据，可以看做一个面板，而面板上的每一点计算都是独立的。所以很自然的就可以想到将这个面板划分成四块，每个进程计算相应部分的点，即如下图所示。

<img src="https://github.com/VistaLing/VistaLing.github.io/blob/master/img/2023/07/2023-07-18-002.png?raw=true" style="zoom: 40%;" />

而这样又产生了新的问题，即算边界点时，需要相邻进程进程的边界值。比如计算进程0最右侧一列的点时，需要进程1最左侧一列点的值。从图中我们可以看出，进程1和进程2所执行的操作是一样的，都需要从左右两进程接收数据，也需要向左右两侧发送数据。而进程0和进程3则是只用往一侧发送和接收数据。但因为我们所编写的是SPMD程序，所有进程执行的都是同一个代码文件。为了保持一致性和代码的可读性，在每一块的左右边界各加上一列。

##### 参考资料

1.都志辉. 高性能计算并行编程技术:MPI并行程序设计[M]. 清华大学出版社, 2001.

2.[两小时入门MPI与并行计算系列 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/355652501)